<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Calendar | Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Add your existing CSS here */
    /* New styles for daily view */
    .daily-view {
      display: none;
      width: 100%;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .daily-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .daily-events {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .time-slot {
      display: flex;
      gap: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .time-label {
      width: 100px;
      font-weight: 500;
      color: #555;
      text-align: right;
    }

    .daily-event {
      flex: 1;
      padding: 15px;
      background: #f0f7ff;
      border-radius: 6px;
      border-left: 4px solid #4a90e2;
      transition: all 0.2s ease;
    }

    .daily-event:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .daily-event.empty {
      background: #f9f9f9;
      border-left: none;
      color: #999;
      font-style: italic;
      text-align: center;
    }

    .daily-event h4 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      color: #333;
    }

    .daily-event p {
      margin: 0;
      font-size: 0.9rem;
      color: #666;
      line-height: 1.4;
    }

    .daily-event .event-time {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.active {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.expired {
      background-color: #ffebee;
      color: #c62828;
    }

    .view-btn.active {
      background-color: #4a90e2;
      color: white;
    }

    .view-btn {
      padding: 8px 15px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-btn:first-child {
      border-radius: 4px 0 0 4px;
    }

    .view-btn:last-child {
      border-radius: 0 4px 4px 0;
    }

    .view-btn:hover {
      background-color: #f0f0f0;
    }

    /* Day navigation controls */
    .day-navigation {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .day-navigation .nav-btn {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: #555;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .day-navigation .nav-btn:hover {
      background: #f0f0f0;
    }

    .day-navigation .current-day {
      font-weight: 500;
      font-size: 1rem;
    }

    /* Today button */
    .today-btn {
      padding: 5px 12px;
      border: 1px solid #4a90e2;
      color: #4a90e2;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .today-btn:hover {
      background: #4a90e2;
      color: white;
    }
  </style>
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="menuToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="https://cdn-icons-png.flaticon.com/512/3652/3652191.png" alt="Smart Calendar Logo">
      <h2>Smart Calendar</h2>
    </div>

    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active">
          <i class="fas fa-calendar-alt"></i>
          <span>Calendar</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="event.html" class="nav-link" id="upcomingEventsLink">
          <i class="fas fa-list-ul"></i>
          <span>Upcoming Events</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="invitation.html" class="nav-link" id="invitation">
          <i class="fas fa-envelope"></i>
          <span>Invitation</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="notification.html" class="nav-link" id="notification">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </a>
      </li>
      <div class="nav-menu">
        <div class="nav-item">
          <a href="#" class="nav-link" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </ul>

  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <h1>My Calendar</h1>

      <div class="user-profile">
        <img src="Photo/3d-rendering-avatar/9720009.jpg" alt="User Profile">
        <div class="user-info">
          <h4 id="usernameDisplay"></h4>
        </div>
      </div>
    </header>

    <!-- Calendar View -->
    <section class="calendar-view">
      <div class="calendar-header">
        <h3 class="calendar-title">October 2023</h3>

        <div class="calendar-actions">
          <div class="view-switcher">
            <button class="view-btn active" id="monthViewBtn">Month</button>
            <button class="view-btn" id="dayViewBtn">Day</button>
          </div>

          <div class="month-navigation">
            <button class="nav-btn" id="prevBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span class="current-month">October 2023</span>
            <button class="nav-btn" id="nextBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <button class="action-btn btn-primary" id="addEventBtn">
            <i class="fas fa-plus"></i> Add Event
          </button>
        </div>
      </div>

      <!-- Monthly Calendar Grid -->
      <div class="month-grid" id="monthView">
        <!-- Day headers will be added by JavaScript -->
      </div>

      <!-- Daily Calendar View -->
      <div class="daily-view" id="dayView">
        <div class="daily-header">
          <div class="day-navigation">
            <button class="nav-btn" id="prevDayBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="daily-title">Tuesday, October 17, 2023</h3>
            <button class="nav-btn" id="nextDayBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
            <button class="today-btn" id="todayBtn">Today</button>
          </div>
        </div>

        <div class="daily-events">
          <!-- Events will be loaded from the database -->
        </div>
      </div>
    </section>
  </main>

  <!-- Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Event</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>

      <div class="modal-body">
        <form id="eventForm">
          <div class="form-group">
            <label for="eventTitle">Event Title</label>
            <input type="text" id="eventTitle" class="form-control" placeholder="Enter event title" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="eventDate">Date</label>
              <input type="date" id="eventDate" class="form-control" required>
            </div>

            <div class="form-group">
              <label for="eventTime">Time</label>
              <input type="time" id="eventTime" class="form-control" required>
            </div>
          </div>

          <div class="form-group">
            <label for="eventDescription">Description</label>
            <textarea id="eventDescription" class="form-control" rows="3"
              placeholder="Enter event description"></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="action-btn btn-outline" id="cancelEvent">Cancel</button>
        <button class="action-btn btn-primary" id="saveEvent">Save Event</button>
      </div>
    </div>
  </div>

  <script>
    // Mobile Menu Toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');

    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
    });

    // Current date state
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // DOM Elements
    const monthViewBtn = document.getElementById('monthViewBtn');
    const dayViewBtn = document.getElementById('dayViewBtn');
    const monthView = document.getElementById('monthView');
    const dayView = document.getElementById('dayView');
    const currentMonthElement = document.querySelector('.current-month');
    const calendarTitle = document.querySelector('.calendar-title');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Fetch events from the server
    async function fetchEvents() {
      try {
        const response = await fetch("http://localhost:8081/api/GetAllEvents", {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        if (response.ok) {
          return await response.json();
        } else {
          console.error('Failed to load events');
          return [];
        }
      } catch (error) {
        console.error('Error fetching events:', error);
        return [];
      }
    }

    // Format date helper
    function formatDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    // Check if event is on specific date
    function isEventOnDate(event, date) {
      const eventDate = new Date(event.date);
      return eventDate.getDate() === date.getDate() &&
        eventDate.getMonth() === date.getMonth() &&
        eventDate.getFullYear() === date.getFullYear();
    }

    // Render month calendar
    async function renderMonthCalendar() {
      // Update title
      const options = { year: 'numeric', month: 'long' };
      const monthYearStr = new Date(currentYear, currentMonth).toLocaleDateString('en-US', options);
      currentMonthElement.textContent = monthYearStr;
      calendarTitle.textContent = monthYearStr;

      // Get all events
      const events = await fetchEvents();

      // Clear grid
      monthView.innerHTML = '';

      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.textContent = day;
        monthView.appendChild(dayHeader);
      });

      // Calculate first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

      // Add previous month days
      for (let i = 0; i < firstDay; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell inactive';
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = daysInPrevMonth - firstDay + i + 1;
        dayCell.appendChild(dayNumber);
        monthView.appendChild(dayCell);
      }

      // Add current month days
      for (let i = 1; i <= daysInMonth; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell';

        // Check if it's today
        const currentDateObj = new Date();
        if (i === currentDateObj.getDate() &&
          currentMonth === currentDateObj.getMonth() &&
          currentYear === currentDateObj.getFullYear()) {
          dayCell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        dayCell.appendChild(dayNumber);

        // Add events for this day
        const dateToCheck = new Date(currentYear, currentMonth, i);
        const eventsOnDay = events.filter(event => isEventOnDate(event, dateToCheck));

        eventsOnDay.forEach(event => {
          const eventItem = document.createElement('div');
          eventItem.className = 'event-item';

          // Add different class based on event status
          if (event.eventstatus === 'Expired') {
            eventItem.classList.add('reminder');
          } else if (event.eventSource === 'Participated') {
            eventItem.classList.add('invitation');
          }

          eventItem.textContent = event.title;
          dayCell.appendChild(eventItem);
        });

        monthView.appendChild(dayCell);
      }

      // Add next month days to fill the grid
      const totalCellsCount = Math.ceil((firstDay + daysInMonth) / 7) * 7;
      const nextMonthDays = totalCellsCount - (firstDay + daysInMonth);

      for (let i = 1; i <= nextMonthDays; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell inactive';
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        dayCell.appendChild(dayNumber);
        monthView.appendChild(dayCell);
      }
    }

    // Render day view
    async function renderDayView() {
      // Update day view title
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dailyTitle = document.querySelector('.daily-title');
      dailyTitle.textContent = currentDate.toLocaleDateString('en-US', options);

      // Get all events
      const events = await fetchEvents();

      // Filter events for current date
      const eventsOnDay = events.filter(event => isEventOnDate(event, currentDate));

      // Clear day view
      const dailyEvents = document.querySelector('.daily-events');
      dailyEvents.innerHTML = '';

      if (eventsOnDay.length > 0) {
        // Sort events by time
        eventsOnDay.sort((a, b) => {
          return a.time.localeCompare(b.time);
        });

        // Group events by hour
        const eventsByHour = {};
        eventsOnDay.forEach(event => {
          const time = event.time.toString();
          const hour = parseInt(time.split(':')[0]);
          if (!eventsByHour[hour]) {
            eventsByHour[hour] = [];
          }
          eventsByHour[hour].push(event);
        });

        // Create time slots for events (8am to 8pm)
        const hours = Array.from({ length: 24 }, (_, i) => i);

        hours.forEach(hour => {
          const eventsThisHour = eventsByHour[hour] || [];

          if (eventsThisHour.length > 0) {
            eventsThisHour.forEach(event => {
              const timeSlot = document.createElement('div');
              timeSlot.className = 'time-slot';

              const timeLabel = document.createElement('div');
              timeLabel.className = 'time-label';
              const hourNum = parseInt(hour);
              const hourFormat = hourNum > 12 ? `${hourNum - 12}:${event.time.split(':')[1]} PM` :
                hourNum === 12 ? `12:${event.time.split(':')[1]} PM` :
                  hourNum === 0 ? `12:${event.time.split(':')[1]} AM` :
                    `${event.time}`;
              timeLabel.textContent = hourFormat;

              const dailyEvent = document.createElement('div');
              dailyEvent.className = 'daily-event';

              // Add different class based on event status
              if (event.eventstatus === 'Expired') {
                dailyEvent.style.borderLeftColor = '#ff9800';
                dailyEvent.style.background = '#fff8e1';
              } else if (event.eventSource === 'Participated') {
                dailyEvent.style.borderLeftColor = '#4caf50';
                dailyEvent.style.background = '#e8f5e9';
              }

              const eventTime = document.createElement('div');
              eventTime.className = 'event-time';
              eventTime.textContent = event.time;

              const eventTitle = document.createElement('h4');
              eventTitle.textContent = event.title;

              const eventDesc = document.createElement('p');
              eventDesc.textContent = event.description || 'No description';

              // Add status badge if needed
              if (event.eventstatus) {
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${event.eventstatus === 'Expired' ? 'expired' : 'active'}`;
                statusBadge.textContent = event.eventstatus;
                eventTime.appendChild(statusBadge);
              }

              dailyEvent.appendChild(eventTime);
              dailyEvent.appendChild(eventTitle);
              dailyEvent.appendChild(eventDesc);

              timeSlot.appendChild(timeLabel);
              timeSlot.appendChild(dailyEvent);

              dailyEvents.appendChild(timeSlot);
            });
          }
        });
      } else {
        // No events for this day
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'time-slot';
        emptyMessage.innerHTML = '<div class="time-label"></div><div class="daily-event empty">No events scheduled for this day</div>';
        dailyEvents.appendChild(emptyMessage);
      }
    }

    // View Switching
    monthViewBtn.addEventListener('click', () => {
      monthViewBtn.classList.add('active');
      dayViewBtn.classList.remove('active');
      monthView.style.display = 'grid';
      dayView.style.display = 'none';
    });

    dayViewBtn.addEventListener('click', () => {
      dayViewBtn.classList.add('active');
      monthViewBtn.classList.remove('active');
      dayView.style.display = 'block';
      monthView.style.display = 'none';
      renderDayView();
    });

    // Month Navigation
    prevBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderMonthCalendar();
    });

    nextBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderMonthCalendar();
    });

    // Event Modal Toggle
    const addEventBtn = document.getElementById('addEventBtn');
    const eventModal = document.getElementById('eventModal');
    const closeModal = document.getElementById('closeModal');
    const cancelEvent = document.getElementById('cancelEvent');

    const showEventModal = () => {
      eventModal.classList.add('active');
    };

    addEventBtn.addEventListener('click', showEventModal);

    closeModal.addEventListener('click', () => {
      eventModal.classList.remove('active');
    });

    cancelEvent.addEventListener('click', () => {
      eventModal.classList.remove('active');
    });

    const saveEvent = document.getElementById('saveEvent');
    const eventForm = document.getElementById('eventForm');

    saveEvent.addEventListener('click', async (e) => {
      e.preventDefault();

      const title = document.getElementById('eventTitle').value;
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const description = document.getElementById('eventDescription').value;

      const eventData = {
        title: title,
        date: date,
        time: time,
        description: description
      };

      if (!title || !date || !time) {
        alert('Please fill in all required fields!');
        return;
      }

      try {
        const response = await fetch("http://localhost:8081/api/Add_Event", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(eventData),
          credentials: 'include'
        });

        if (response.ok) {
          const resultText = await response.text();
          if (resultText === "SUCCESS") {
            alert('Event saved successfully!');
            eventModal.classList.remove('active');
            eventForm.reset();

            // Refresh the calendar view
            if (monthView.style.display !== 'none') {
              renderMonthCalendar();
            } else {
              renderDayView();
            }
          }
          else {
            alert('Failed to save event.');
          }
        }
      }
      catch (error) {
        console.error('Error:', error);
        alert('Error saving event.');
      }
    });

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const response = await fetch("http://localhost:8081/api/logout", {
          method: 'POST',
          credentials: 'include',
        });

        if (response.ok) {
          alert('Logged out successfully!');
          window.location.href = "login.html";
        }
        else {
          alert('Failed to logout.');
        }
      }
      catch (error) {
        console.error('Logout error:', error);
        alert('An error occurred during logout.');
      }
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    document.addEventListener('DOMContentLoaded', function () {
      const username = getCookie('userName');
      document.getElementById('usernameDisplay').textContent = username;

      // Initialize calendar views
      renderMonthCalendar();

      // Initialize with month view
      monthViewBtn.classList.add('active');
      monthView.style.display = 'grid';
      dayView.style.display = 'none';

      // Set today's date as default in the form
      document.getElementById('eventDate').valueAsDate = new Date();
    });

    // Day Navigation
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const todayBtn = document.getElementById('todayBtn');

    prevDayBtn.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() - 1);
      renderDayView();
    });

    nextDayBtn.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() + 1);
      renderDayView();
    });

    todayBtn.addEventListener('click', () => {
      currentDate = new Date();
      renderDayView();
    });
  </script>
</body>

</html>